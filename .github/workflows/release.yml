name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬'
        required: true
        default: '1.0.0'
        type: string
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - prerelease
          - draft

env:
  MAVEN_OPTS: -Xmx2048m -XX:+UseG1GC
  CI: true

jobs:
  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    name: æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: 'temurin'
        cache: maven
    
    - name: è¿è¡Œæ‰€æœ‰æµ‹è¯•
      run: |
        mvn clean test -B
        mvn verify -B
      env:
        CI: true
        DB_TYPE: h2
    
    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      run: mvn jacoco:report -B
    
    - name: æ„å»ºé¡¹ç›®
      run: mvn clean package -B -DskipTests
    
    - name: ç”Ÿæˆæºç åŒ…
      run: mvn source:jar -B
    
    - name: ç”Ÿæˆæ–‡æ¡£
      run: mvn javadoc:jar -B
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts
        path: |
          **/target/*.jar
          **/target/*-sources.jar
          **/target/*-javadoc.jar
        retention-days: 30

  # å‘å¸ƒåˆ° Maven Central
  publish-maven:
    name: å‘å¸ƒåˆ° Maven Central
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: 'temurin'
        cache: maven
    
    - name: é…ç½® Maven è®¾ç½®
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << EOF
        <settings>
          <servers>
            <server>
              <id>ossrh</id>
              <username>\${env.OSSRH_USERNAME}</username>
              <password>\${env.OSSRH_TOKEN}</password>
            </server>
          </servers>
        </settings>
        EOF
    
    - name: å‘å¸ƒåˆ° Maven Central
      run: mvn deploy -B -DskipTests
      env:
        OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        OSSRH_TOKEN: ${{ secrets.OSSRH_TOKEN }}

  # åˆ›å»º GitHub Release
  create-release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    needs: [build-and-test, publish-maven]
    if: always() && (needs.build-and-test.result == 'success')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        fi
    
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        
        if [ -n "$PREVIOUS_TAG" ]; then
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          echo "## å˜æ›´æ—¥å¿—" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD >> CHANGELOG.md
          echo "" >> CHANGELOG.md
        else
          # é¦–æ¬¡å‘å¸ƒ
          echo "## é¦–æ¬¡å‘å¸ƒ" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "è¿™æ˜¯ VXCore æ¡†æ¶çš„é¦–æ¬¡å‘å¸ƒã€‚" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
        fi
        
        # æ·»åŠ åŠŸèƒ½ç‰¹æ€§
        echo "## ä¸»è¦ç‰¹æ€§" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- ğŸš€ åŸºäº Vert.x çš„é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶" >> CHANGELOG.md
        echo "- ğŸ—„ï¸ æ”¯æŒ H2ã€MySQLã€PostgreSQL æ•°æ®åº“" >> CHANGELOG.md
        echo "- ğŸ”§ å®Œæ•´çš„ä»£ç ç”Ÿæˆå™¨" >> CHANGELOG.md
        echo "- ğŸŒ WebSocket å’Œåå‘ä»£ç†æ”¯æŒ" >> CHANGELOG.md
        echo "- ğŸ“Š å®Œå–„çš„æµ‹è¯•è¦†ç›–" >> CHANGELOG.md
        echo "- ğŸ”’ ä¼ä¸šçº§å®‰å…¨ç‰¹æ€§" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        # æ·»åŠ ä½¿ç”¨è¯´æ˜
        echo "## å¿«é€Ÿå¼€å§‹" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "\`\`\`xml" >> CHANGELOG.md
        echo "<dependency>" >> CHANGELOG.md
        echo "    <groupId>cn.qaiu</groupId>" >> CHANGELOG.md
        echo "    <artifactId>core</artifactId>" >> CHANGELOG.md
        echo "    <version>${{ steps.get_version.outputs.VERSION }}</version>" >> CHANGELOG.md
        echo "</dependency>" >> CHANGELOG.md
        echo "\`\`\`" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        # æ·»åŠ æ–‡æ¡£é“¾æ¥
        echo "## æ–‡æ¡£" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- [å¿«é€Ÿå¼€å§‹](https://github.com/qaiu/vxcore/blob/main/docs/02-quick-start.md)" >> CHANGELOG.md
        echo "- [æ¶æ„è®¾è®¡](https://github.com/qaiu/vxcore/blob/main/docs/04-architecture.md)" >> CHANGELOG.md
        echo "- [API æ–‡æ¡£](https://github.com/qaiu/vxcore/blob/main/docs/)" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        # è¾“å‡ºå˜æ›´æ—¥å¿—
        cat CHANGELOG.md
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        cat CHANGELOG.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: release-artifacts
        path: artifacts
    
    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.VERSION }}
        name: VXCore v${{ steps.get_version.outputs.VERSION }}
        body: ${{ steps.changelog.outputs.CHANGELOG }}
        draft: ${{ github.event.inputs.release_type == 'draft' }}
        prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}
        files: |
          artifacts/**/*.jar
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å‘å¸ƒåˆ° Docker Hub
  publish-docker:
    name: å‘å¸ƒåˆ° Docker Hub
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ç™»å½• Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}
    
    - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          qaiu/vxcore:latest
          qaiu/vxcore:${{ github.ref_name }}
        platforms: linux/amd64,linux/arm64

  # å‘å¸ƒé€šçŸ¥
  notify:
    name: å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [create-release, publish-maven, publish-docker]
    if: always()
    
    steps:
    - name: å‘é€ Slack é€šçŸ¥
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: "ğŸ‰ VXCore v${{ github.ref_name }} å‘å¸ƒæˆåŠŸï¼"
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
    
    - name: å‘é€å¤±è´¥é€šçŸ¥
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: "âŒ VXCore v${{ github.ref_name }} å‘å¸ƒå¤±è´¥ï¼"
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}